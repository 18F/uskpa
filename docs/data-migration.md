## Migrating the Legacy USKPA data
[:arrow_left: Back to USKPA
Documentation](../docs)

### Legacy USKPA database

The legacy data is contained within an MS SQL 2012 database.


### Migration

The legacy data migration has 4 primary components, executed in order.

1. Extract data from MS SQL 2012
2. Prepare extracted data for processing
3. Transform prepared data to match new data model
4. Import data to postgres database


#### Data Extraction

Selected tables from the legacy database shall be exported to a CSV file.

Tables utilized in migration:
 - tblCertificate
 - tblCountries
 - tblState
 - tblLicensee
 - tlbDeliveryStatus
 - tblHCDCodes
 - tblPortOfExport

#### Data Preparation

The address fields within the exported `tblCertificates.csv` file contain `\n` characters without surrounding field qualifiers. This corrupts the expected CSV format by having certificate records which span lines leading to truncated and otherwise unexpected data upon import.

To re-mediate this file, regular expressions are used to identify and replace the offending `\n` characters with `|`. These character replacements will be reverted prior to final import to the new database.

#### Data Transformation

Transformations performed upon incoming Certificate data fields.

##### Certificate Number
 - Certificates with numbers less than 10000 are excluded from the migration as they are records which were created for testing purposes.

##### Status
  - If `VoidCert==True`, set status to `Certificate.VOID`
  - If no incoming status and `VoidCert not True`, set status to `Certificate.AVAILABLE`
  - Otherwise, map incoming status to `Certificate.SHIPPED` or `Certificate.DELIVERED`

##### Licensee
  - Certificates excluded if `LicenseeID in (17, 34)` these are test licensees
  - Licensee set to `None` if LicenseeID not found in `tblLicensee`, only expecting licensee ID: 23.

##### AES
 - Convert `x` to `X`
 - If value is 14 digits, pre-pend with `X`.
 - Imported as-is, even if AES format validation fails.

##### Port of Export
  - Values modified to be consistent w/ those present in `tblPortOfExport`
  - Converted to a ForeignKey relationship

##### ImporterCountry
  - Values modified to conform to latest ISO-3166 short-names.

##### Consignee Address
  - Insert `ImporterCountry` at end of address, if not already present

#### Data Import

The final data import, and overall orchestration of the migration process is handled via Django management commands.

The data migration should only be executed on a new database which has no `Licensee` or `Certificate` records.


##### Steps to migrate data locally:

**Note:** These steps assume that a local development database has already been established per the [local development instructions.](./local-development.md)

1. Copy exported CSV files into a directory, `./data`, in the same folder as `manage.py`
2. Load initial data:
    ```
    docker-compose run app python manage.py loaddata initial_data
    ```
3. Import Licensee data:
    ```
    docker-compose run app python manage.py load_licensees ./data/tblLicensee.csv
    ```
4. Import Certificate data:
    ```
    docker-compose run app python manage.py load_certs ./data/tblCertificate.csv
    ```

Output contains summary information and any warning messages generated by the processing indicating unhandled or otherwise suspicious values. If desired, this output can be directed to a local file for later review.

Example:

```
docker-compose run app python manage.py load_certs ./data/tblCertificate.csv > output.log
```

##### Steps to migrate data to a Heroku Instance:

**Note:** These steps assume that a Heroku app has already been established per the [deploy instructions.](./deploy.md)

Populating a Heroku app with the migrated data will be accomplished by executing the migration scripts locally, against the Heroku app's database. To do that we need to configure our local instance to establish a connection with the heroku application's database.

1. Retrieve Heroku app database credentials as a database URL -- `postgres://{username}:{password}@{host}:{port}/{database name}`

    a. From the Heroku CLI:
      ```
      heroku config:get DATABASE_URL
      ```
    b. From the Heroku dashboard, configuration variables page.

2. Point our local instance at the heroku database and execute migration following slightly modified version of steps above:

    1. Copy exported CSV files into a directory, `./data`, in the same folder as `manage.py`

    2. Execute migration from docker container:

      ```bash
      docker-compose run app bash
      export DATABASE_URL=<URL FROM HEROKU>
      python manage.py loaddata initial_data
      python manage.py load_licensees ./data/tblLicensee.csv
      python manage.py load_certs ./data/tblCertificate.csv
      ```
